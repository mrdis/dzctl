<!DOCTYPE html>
<html>
    <head>
        <title>Deezer Controller</title>

        <style>
            body {
                background: #eee;
            }
        
            h1 {
                font: normal normal normal 34px arial;
            }
            h2 {
                font: normal normal normal 28px arial;
            }
        
            .container {
                margin: auto; top: 20px; left:0; right:0; padding: 20px; width: 400px; border: 1px solid #ccc; background: white; border-radius: 5px; color: black;
            }
            
            .big-text {
                font: normal normal normal 20px arial;
            }
            

        </style>
        <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <script src="peerctl-cli.js"></script>
    </head>
    <body>
        <div class="container">
            <h1>Deezer Controller</h1>
            <div>
                <h2>Connect</h2>
                Peer ID         
                <input type="tel" id="peerid"/>
                <br/>
                PIN
                <input type="tel" id="pin"/>
                <br/>
                <div>
                    <a id="connect-link" class="big-text">
                        Connect
                    </a>
                </div>
            </div>
            <div>
                <h2>Navigation</h2>
                <div id="navi-content">
                </div>
            </div>
            <div>
                <h2>Browse</h2>
                <div id="playlists"></div>
                <div id="tracks"></div>
                <h3>Search</h3>
                <input type="text" id="search-text"/>
                <a href="javascript:searchText()">Search</a>
                <div id="browser-content">
                </div>
            </div>
            <div>
                <h2>Status</h2>
                Playing : <span id="current-artist"></span> - <span id="current-song"></span>
            </div>
            <div>
                <h2>Controls</h2>
                <a href="javascript:togglePlay()">Play/Pause</a>
                <a href="javascript:next()">Next</a>
                <a href="javascript:toggleMute()">Mute/Unmute</a>
            </div>
        </div>
        
        
        <script>
            var id = localStorage.getItem('dzctl-id');
            if(id){
                document.getElementById("peerid").value = id;
            }


            const link = document.getElementById('connect-link')           
            link.href = `javascript:connect()`

            var cli;

            function connect(){
                const id  = document.getElementById("peerid").value;
                const pin = document.getElementById('pin').value
                cli = new PeerCtlClient()
                cli.on('status',renderStatus)
                cli.connect("dzctl",id,pin)
            }

            function setText(elemId,text){
                const elem = document.getElementById(elemId)
                if(elem)
                    elem.innerText = text
            }

            function renderItems(parentid,items,title){
                if(!items)return
                const parent = document.getElementById(parentid)
                parent.innerHTML=""
                if(title){
                    const h = document.createElement('h3')
                    h.innerText = title
                    parent.append(h)
                }
                const ul = document.createElement('ul')
                items.forEach(function(item){
                    if(!item)return
                    const li = document.createElement('li') 
                    const a = document.createElement('a')
                    a.href="javascript:navigate('"+item.path+"')"
                    if(item.html)
                        a.innerHTML = item.html
                    else if(item.title)
                        a.innerText = item.title
                    else if(item.name)
                        a.innerText = item.name
                    li.append(a)

                    if(item.play){
                        const a = document.createElement('a')
                        a.href="javascript:play('"+item.play+"')"
                        a.innerText = "[play]"
                        li.append(a)
                    }

                    if(item.scroll){
                        const a = document.createElement('a')
                        a.href="javascript:scroll('"+item.scroll+"')"
                        a.innerText = "[scroll]"
                        li.append(a)
                    }

                    ul.append(li)
                });
                parent.append(ul)
            }

            function renderStatus(status){
                console.log(status)

                if(status.currentSong){
                    setText("current-artist",status.currentSong.ART_NAME)
                    setText("current-song",status.currentSong.SNG_TITLE)
                }else{
                    setText("current-artist","")
                    setText("current-song"  ,"")
                }

                if(status.currentSearch){
                    renderItems('browser-content',status.currentSearch.tracks)
                }

                renderItems('navi-content',status.navi)
                renderItems('playlists',status.playlists,"Playlists")
                renderItems('tracks',status.tracks,"Tracks")

            }

            // Common action utils
            function send(command,params){
                cli.send(command,params)
            }
            function sendClickOn(descriptor){
                send('clickOn',descriptor)
            }

            // Actions
            function togglePlay(){sendClickOn("togglePlay")}
            function next      (){sendClickOn("next")}
            function toggleMute(){sendClickOn("toggleMute")}
            function searchText() {send("search",document.getElementById("search-text").value)}
            function navigate(path){send('navigate',path)}
            function play(path){send('play',path)}
            function scroll(path){send('scroll',path)}
        </script>
    </body>
</html>